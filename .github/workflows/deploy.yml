name: Deploy to Linode

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod
  release:
    types: [published]

env:
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/derecksnotes

jobs:
  build_and_push:
    name: Build and push Docker image
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      image_tag: ${{ steps.set-env.outputs.image_tag }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "image_tag=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "image_tag=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.set-env.outputs.image_tag }}
            ${{ github.event_name == 'release' && format('{0}:{1}', env.IMAGE_NAME, github.event.release.tag_name) || '' }}
          build-args: |
            BUILD_ENV=${{ steps.set-env.outputs.environment }}

  deploy:
    name: Deploy to Linode
    needs: build_and_push
    runs-on: ubuntu-latest
    env:
      ENV: ${{ needs.build_and_push.outputs.environment }}
      TAG: ${{ needs.build_and_push.outputs.image_tag }}
    steps:
      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ env.ENV }}" = "prod" ]; then
            echo "container_name=prod_derecksnotes" >> $GITHUB_OUTPUT
            echo "work_dir=/root/prod_docker-compose-derecksnotes/" >> $GITHUB_OUTPUT
            echo "port_client=3000" >> $GITHUB_OUTPUT
            echo "port_server=3001" >> $GITHUB_OUTPUT
          else
            echo "container_name=dev_derecksnotes" >> $GITHUB_OUTPUT
            echo "work_dir=/root/dev_docker-compose-derecksnotes/" >> $GITHUB_OUTPUT
            echo "port_client=3010" >> $GITHUB_OUTPUT
            echo "port_server=3011" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USERNAME }}
          password: ${{ secrets.REMOTE_PASSWORD }}
          port: ${{ secrets.REMOTE_PORT }}
          command_timeout: 20m
          script: |
            mkdir -p ${{ steps.vars.outputs.work_dir }}
            cd ${{ steps.vars.outputs.work_dir }}

            # Create docker-compose.yml
            cat > docker-compose.yml << EOF
            services:
              derecksnotes:
                image: ${{ env.IMAGE_NAME }}:${{ env.TAG }}
                container_name: ${{ steps.vars.outputs.container_name }}
                ports:
                  - "${{ steps.vars.outputs.port_client }}:3000"
                  - "${{ steps.vars.outputs.port_server }}:3001"
                environment:
                  - BUILD_ENV=${{ env.ENV }}
                  - SESSION_SECRET=${{ secrets.SESSION_SECRET }}
                networks:
                  - dereck-network
                restart: unless-stopped
                volumes:
                  - ./data:/app/data
                  - /var/www/derecksnotes.com/public:/app/client/public

            networks:
              dereck-network:
                external: true
            EOF

            # Pull and deploy
            docker pull ${{ env.IMAGE_NAME }}:${{ env.TAG }}
            docker container prune -f
            docker rm -f ${{ steps.vars.outputs.container_name }} || true
            docker compose --project-name derecksnotes-${{ env.ENV }} down || true
            docker compose --project-name derecksnotes-${{ env.ENV }} up -d
