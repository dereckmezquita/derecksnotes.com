---
title: "False Discovery Rate"
subtitle: "Part 2 of Chapter 15: Multiple Comparisons"
author: "Dereck Mezquita"
date: "2026-01-19"
output: html_document
---



## Table of Contents

## 15.8 The False Discovery Rate (FDR)

### 15.8.1 A Different Philosophy

While FWER controls the probability of ANY false positive, this is often too strict for exploratory research. The **False Discovery Rate (FDR)** instead controls the expected proportion of false positives among all rejections.


``` r
box::use(
    data.table[...],
    ggplot2
)
```


``` r
cat("FWER vs FDR Philosophy\n")
```

```
## FWER vs FDR Philosophy
```

``` r
cat("======================\n\n")
```

```
## ======================
```

``` r
cat("FWER: 'I want to be sure that if I claim ANY discovery,\n")
```

```
## FWER: 'I want to be sure that if I claim ANY discovery,
```

``` r
cat("       it is a true discovery.'\n")
```

```
##        it is a true discovery.'
```

``` r
cat("       → Controls: P(at least 1 false positive)\n\n")
```

```
##        <U+2192> Controls: P(at least 1 false positive)
```

``` r
cat("FDR:  'I accept that some of my discoveries may be false,\n")
```

```
## FDR:  'I accept that some of my discoveries may be false,
```

``` r
cat("       but I want the FALSE PROPORTION to be small.'\n")
```

```
##        but I want the FALSE PROPORTION to be small.'
```

``` r
cat("       → Controls: E[false positives / total positives]\n\n")
```

```
##        <U+2192> Controls: E[false positives / total positives]
```

``` r
cat("Example:\n")
```

```
## Example:
```

``` r
cat("  - 100 discoveries total\n")
```

```
##   - 100 discoveries total
```

``` r
cat("  - FDR = 5% means ~5 are expected to be false positives\n")
```

```
##   - FDR = 5% means ~5 are expected to be false positives
```

``` r
cat("  - This is often acceptable in exploratory research\n")
```

```
##   - This is often acceptable in exploratory research
```

### 15.8.2 Formal Definition

Let:
- V = number of false positives (falsely rejected null hypotheses)
- R = total number of rejections
- Q = V/R (proportion of false discoveries)

Then FDR = E[Q], where Q = 0 if R = 0.

---

## 15.9 The Benjamini-Hochberg Procedure

### 15.9.1 The Algorithm

The **Benjamini-Hochberg (BH)** procedure controls FDR at level q:

1. Order p-values: $p_{(1)} \leq p_{(2)} \leq \cdots \leq p_{(m)}$
2. Find the largest k such that $p_{(k)} \leq \frac{k}{m} \cdot q$
3. Reject all hypotheses with $p_{(i)} \leq p_{(k)}$


``` r
# Simulate data with some true effects
set.seed(123)
n_tests <- 1000
n_true <- 100

# Generate p-values
p_values <- c(
    rbeta(n_true, 0.3, 1),           # True effects (small p-values)
    runif(n_tests - n_true, 0, 1)    # Null (uniform p-values)
)
true_effect <- c(rep(TRUE, n_true), rep(FALSE, n_tests - n_true))

# Apply BH procedure
results <- data.table(
    test = 1:n_tests,
    true_effect = true_effect,
    p_value = p_values
)
results <- results[order(p_value)]
results[, rank := 1:.N]
results[, bh_threshold := (rank / n_tests) * 0.05]

# Find largest k where p <= k/m * q
results[, reject_bh := p_value <= bh_threshold]

# The BH-adjusted p-values
results[, bh_adjusted := p.adjust(p_value, method = "BH")]
results[, reject_bh_adj := bh_adjusted < 0.05]

cat("Benjamini-Hochberg Procedure (FDR = 5%)\n")
```

```
## Benjamini-Hochberg Procedure (FDR = 5%)
```

``` r
cat("=======================================\n\n")
```

```
## =======================================
```

``` r
cat("Top 20 ordered p-values with BH thresholds:\n")
```

```
## Top 20 ordered p-values with BH thresholds:
```

``` r
print(results[1:20, .(rank, p_value, bh_threshold, reject = p_value <= bh_threshold)])
```

```
##      rank      p_value bh_threshold reject
##     <int>        <num>        <num> <lgcl>
##  1:     1 5.339757e-12      0.00005   TRUE
##  2:     2 4.743698e-07      0.00010   TRUE
##  3:     3 3.032597e-05      0.00015   TRUE
##  4:     4 4.076487e-05      0.00020   TRUE
##  5:     5 2.228078e-04      0.00025   TRUE
##  6:     6 2.367048e-04      0.00030   TRUE
##  7:     7 3.175549e-04      0.00035   TRUE
##  8:     8 4.653491e-04      0.00040  FALSE
##  9:     9 5.147268e-04      0.00045  FALSE
## 10:    10 5.880987e-04      0.00050  FALSE
## 11:    11 8.365398e-04      0.00055  FALSE
## 12:    12 1.113020e-03      0.00060  FALSE
## 13:    13 1.155820e-03      0.00065  FALSE
## 14:    14 1.191628e-03      0.00070  FALSE
## 15:    15 1.198311e-03      0.00075  FALSE
## 16:    16 1.323559e-03      0.00080  FALSE
## 17:    17 2.152877e-03      0.00085  FALSE
## 18:    18 2.478810e-03      0.00090  FALSE
## 19:    19 3.010602e-03      0.00095  FALSE
## 20:    20 3.307298e-03      0.00100  FALSE
##      rank      p_value bh_threshold reject
```

``` r
cat(sprintf("\n\nTotal rejections: %d\n", sum(results$reject_bh)))
```

```
## 
## 
## Total rejections: 7
```

``` r
cat(sprintf("True positives: %d\n", sum(results$reject_bh & results$true_effect)))
```

```
## True positives: 7
```

``` r
cat(sprintf("False positives: %d\n", sum(results$reject_bh & !results$true_effect)))
```

```
## False positives: 0
```

``` r
cat(sprintf("Observed FDR: %.3f\n",
            sum(results$reject_bh & !results$true_effect) / sum(results$reject_bh)))
```

```
## Observed FDR: 0.000
```

### 15.9.2 Visualising the BH Procedure


``` r
# Create visualisation
plot_data <- results[1:200]  # First 200 for clarity

ggplot2$ggplot(plot_data, ggplot2$aes(x = rank, y = p_value)) +
    ggplot2$geom_point(ggplot2$aes(colour = reject_bh), size = 1.5) +
    ggplot2$geom_line(ggplot2$aes(y = bh_threshold), colour = "#D55E00", linewidth = 1) +
    ggplot2$scale_colour_manual(values = c("#0072B2", "#009E73"),
                                 labels = c("Not Rejected", "Rejected")) +
    ggplot2$labs(
        title = "Benjamini-Hochberg Procedure",
        subtitle = "Orange line: BH threshold (k/m × q); Points below line are rejected",
        x = "Rank",
        y = "P-Value",
        colour = ""
    ) +
    ggplot2$theme_minimal(base_size = 12) +
    ggplot2$theme(legend.position = "bottom")
```

![plot of chunk bh_visual](/courses/statistics-1-foundations/bh_visual-1.png)

---

## 15.10 Comparing FWER and FDR Control

### 15.10.1 Simulation Comparison


``` r
# Compare different methods
results[, `:=`(
    bonf_adjusted = p.adjust(p_value, method = "bonferroni"),
    holm_adjusted = p.adjust(p_value, method = "holm")
)]
results[, `:=`(
    reject_bonf = bonf_adjusted < 0.05,
    reject_holm = holm_adjusted < 0.05
)]

comparison <- data.table(
    Method = c("Uncorrected", "Bonferroni", "Holm", "Benjamini-Hochberg"),
    Type = c("None", "FWER", "FWER", "FDR"),
    Total_Rejections = c(
        sum(results$p_value < 0.05),
        sum(results$reject_bonf),
        sum(results$reject_holm),
        sum(results$reject_bh)
    ),
    True_Positives = c(
        sum(results$p_value < 0.05 & results$true_effect),
        sum(results$reject_bonf & results$true_effect),
        sum(results$reject_holm & results$true_effect),
        sum(results$reject_bh & results$true_effect)
    ),
    False_Positives = c(
        sum(results$p_value < 0.05 & !results$true_effect),
        sum(results$reject_bonf & !results$true_effect),
        sum(results$reject_holm & !results$true_effect),
        sum(results$reject_bh & !results$true_effect)
    )
)

comparison[, Sensitivity := True_Positives / n_true]
comparison[, FDR := False_Positives / Total_Rejections]

cat("Comparison of Correction Methods\n")
```

```
## Comparison of Correction Methods
```

``` r
cat("=================================\n\n")
```

```
## =================================
```

``` r
cat(sprintf("Total tests: %d (100 true effects, 900 null)\n\n", n_tests))
```

```
## Total tests: 1000 (100 true effects, 900 null)
```

``` r
print(comparison)
```

```
##                Method   Type Total_Rejections True_Positives False_Positives
##                <char> <char>            <int>          <int>           <int>
## 1:        Uncorrected   None               87             37              50
## 2:         Bonferroni   FWER                4              4               0
## 3:               Holm   FWER                4              4               0
## 4: Benjamini-Hochberg    FDR                7              7               0
##    Sensitivity       FDR
##          <num>     <num>
## 1:        0.37 0.5747126
## 2:        0.04 0.0000000
## 3:        0.04 0.0000000
## 4:        0.07 0.0000000
```

``` r
cat("\n\nKey observations:\n")
```

```
## 
## 
## Key observations:
```

``` r
cat("• Uncorrected: High sensitivity but many false positives\n")
```

```
## <U+2022> Uncorrected: High sensitivity but many false positives
```

``` r
cat("• FWER methods: Very few false positives but low sensitivity\n")
```

```
## <U+2022> FWER methods: Very few false positives but low sensitivity
```

``` r
cat("• FDR (BH): Good balance—high sensitivity with controlled FDR\n")
```

```
## <U+2022> FDR (BH): Good balance<U+2014>high sensitivity with controlled FDR
```

### 15.10.2 Visual Comparison


``` r
comp_long <- melt(comparison, id.vars = c("Method", "Type"),
                  measure.vars = c("True_Positives", "False_Positives"),
                  variable.name = "Outcome", value.name = "Count")

comp_long[, Method := factor(Method, levels = c("Uncorrected", "Bonferroni",
                                                  "Holm", "Benjamini-Hochberg"))]

ggplot2$ggplot(comp_long, ggplot2$aes(x = Method, y = Count, fill = Outcome)) +
    ggplot2$geom_col(position = "dodge") +
    ggplot2$scale_fill_manual(values = c("#009E73", "#D55E00"),
                               labels = c("True Positives", "False Positives")) +
    ggplot2$labs(
        title = "Comparison of Multiple Testing Corrections",
        subtitle = "100 true effects among 1000 tests",
        x = "",
        y = "Count",
        fill = ""
    ) +
    ggplot2$theme_minimal(base_size = 12) +
    ggplot2$theme(axis.text.x = ggplot2$element_text(angle = 20, hjust = 1),
                  legend.position = "bottom")
```

![plot of chunk comparison_visual](/courses/statistics-1-foundations/comparison_visual-1.png)

---

## 15.11 Q-Values

### 15.11.1 The Q-Value Concept

A **q-value** is the minimum FDR at which a particular test would be called significant. It's the FDR analog of the p-value.


``` r
# Calculate q-values (BH-adjusted p-values are essentially q-values)
results[, q_value := bh_adjusted]

cat("Q-Values\n")
```

```
## Q-Values
```

``` r
cat("========\n\n")
```

```
## ========
```

``` r
cat("Interpretation:\n")
```

```
## Interpretation:
```

``` r
cat("• p-value: probability of observing this result if null is true\n")
```

```
## <U+2022> p-value: probability of observing this result if null is true
```

``` r
cat("• q-value: expected proportion of false positives among all\n")
```

```
## <U+2022> q-value: expected proportion of false positives among all
```

``` r
cat("           results with this q-value or smaller\n\n")
```

```
##            results with this q-value or smaller
```

``` r
cat("Example from our data:\n")
```

```
## Example from our data:
```

``` r
example_tests <- results[1:10, .(rank, p_value, q_value, true_effect)]
print(example_tests)
```

```
##      rank      p_value      q_value true_effect
##     <int>        <num>        <num>      <lgcl>
##  1:     1 5.339757e-12 5.339757e-09        TRUE
##  2:     2 4.743698e-07 2.371849e-04        TRUE
##  3:     3 3.032597e-05 1.010866e-02        TRUE
##  4:     4 4.076487e-05 1.019122e-02        TRUE
##  5:     5 2.228078e-04 3.945080e-02        TRUE
##  6:     6 2.367048e-04 3.945080e-02        TRUE
##  7:     7 3.175549e-04 4.536499e-02        TRUE
##  8:     8 4.653491e-04 5.719186e-02       FALSE
##  9:     9 5.147268e-04 5.719186e-02        TRUE
## 10:    10 5.880987e-04 5.880987e-02        TRUE
```

``` r
cat("\nIf we reject all tests with q < 0.05, we expect ~5% to be false positives.\n")
```

```
## 
## If we reject all tests with q < 0.05, we expect ~5% to be false positives.
```

---

## 15.12 Local FDR and Posterior Probability

### 15.12.1 Beyond Global FDR

The **local false discovery rate (lfdr)** estimates the probability that a specific test is a false positive, given its test statistic.


``` r
cat("Local FDR Concept\n")
```

```
## Local FDR Concept
```

``` r
cat("=================\n\n")
```

```
## =================
```

``` r
cat("Global FDR (q-value): 'If I reject all tests at this level,\n")
```

```
## Global FDR (q-value): 'If I reject all tests at this level,
```

``` r
cat("                       what proportion are false positives?'\n\n")
```

```
##                        what proportion are false positives?'
```

``` r
cat("Local FDR (lfdr):     'What is the probability that THIS specific\n")
```

```
## Local FDR (lfdr):     'What is the probability that THIS specific
```

``` r
cat("                       test is a false positive?'\n\n")
```

```
##                        test is a false positive?'
```

``` r
cat("The local FDR uses the mixture model:\n")
```

```
## The local FDR uses the mixture model:
```

``` r
cat("• π₀ = proportion of null hypotheses\n")
```

```
## <U+2022> <U+03C0><U+2080> = proportion of null hypotheses
```

``` r
cat("• f₀(z) = density of test statistics under null\n")
```

```
## <U+2022> f<U+2080>(z) = density of test statistics under null
```

``` r
cat("• f₁(z) = density of test statistics under alternative\n\n")
```

```
## <U+2022> f<U+2081>(z) = density of test statistics under alternative
```

``` r
cat("lfdr(z) = π₀ × f₀(z) / [π₀ × f₀(z) + (1-π₀) × f₁(z)]\n")
```

```
## lfdr(z) = <U+03C0><U+2080> <U+00D7> f<U+2080>(z) / [<U+03C0><U+2080> <U+00D7> f<U+2080>(z) + (1-<U+03C0><U+2080>) <U+00D7> f<U+2081>(z)]
```

---

## 15.13 Adaptive FDR Procedures

### 15.13.1 Estimating π₀

The BH procedure assumes all nulls could be true. If we can estimate the proportion of true nulls (π₀), we can gain power:


``` r
# Estimate π₀ using Storey's method (simplified)
# Use p-values in (0.5, 1) to estimate proportion of nulls

lambda <- 0.5
pi0_estimate <- sum(results$p_value > lambda) / ((1 - lambda) * n_tests)

cat("Estimating π₀ (Proportion of True Nulls)\n")
```

```
## Estimating <U+03C0><U+2080> (Proportion of True Nulls)
```

``` r
cat("=========================================\n\n")
```

```
## =========================================
```

``` r
cat(sprintf("True π₀: %.2f\n", (n_tests - n_true) / n_tests))
```

```
## True <U+03C0><U+2080>: 0.90
```

``` r
cat(sprintf("Estimated π₀ (Storey's method): %.3f\n\n", pi0_estimate))
```

```
## Estimated <U+03C0><U+2080> (Storey's method): 0.948
```

``` r
cat("If π₀ < 1, we can use adaptive procedures for more power.\n")
```

```
## If <U+03C0><U+2080> < 1, we can use adaptive procedures for more power.
```

``` r
cat("The BH procedure is conservative when many alternatives exist.\n")
```

```
## The BH procedure is conservative when many alternatives exist.
```

### 15.13.2 Storey's Q-Value Approach


``` r
# Adaptive BH using π₀ estimate
results[, adaptive_q := bh_adjusted * pi0_estimate]

# Compare
cat("Adaptive vs Standard BH\n")
```

```
## Adaptive vs Standard BH
```

``` r
cat("=======================\n\n")
```

```
## =======================
```

``` r
cat(sprintf("Standard BH rejections (q < 0.05): %d\n", sum(results$q_value < 0.05)))
```

```
## Standard BH rejections (q < 0.05): 7
```

``` r
cat(sprintf("Adaptive BH rejections (q < 0.05): %d\n", sum(results$adaptive_q < 0.05)))
```

```
## Adaptive BH rejections (q < 0.05): 7
```

``` r
cat("\nAdaptive methods can increase power when many alternatives exist.\n")
```

```
## 
## Adaptive methods can increase power when many alternatives exist.
```

---

## 15.14 Practical Considerations

### 15.14.1 When to Use FDR

| Situation | Recommendation |
|-----------|----------------|
| Genomics, proteomics | FDR strongly preferred |
| Exploratory analyses | FDR appropriate |
| Large-scale screens | FDR necessary |
| Confirmatory research | FWER may be preferred |
| High stakes (drug approval) | FWER usually required |

### 15.14.2 Choosing the FDR Level


``` r
fdr_levels <- c(0.01, 0.05, 0.10, 0.20)

sensitivity <- sapply(fdr_levels, function(q) {
    sum(p.adjust(results$p_value, method = "BH") < q & results$true_effect) / n_true
})

fdr_observed <- sapply(fdr_levels, function(q) {
    rejected <- p.adjust(results$p_value, method = "BH") < q
    if (sum(rejected) == 0) return(NA)
    sum(rejected & !results$true_effect) / sum(rejected)
})

fdr_table <- data.table(
    Target_FDR = fdr_levels,
    Rejections = sapply(fdr_levels, function(q) sum(p.adjust(results$p_value, method = "BH") < q)),
    Sensitivity = sensitivity,
    Observed_FDR = fdr_observed
)

cat("Impact of FDR Level Choice\n")
```

```
## Impact of FDR Level Choice
```

``` r
cat("==========================\n\n")
```

```
## ==========================
```

``` r
print(fdr_table)
```

```
##    Target_FDR Rejections Sensitivity Observed_FDR
##         <num>      <int>       <num>        <num>
## 1:       0.01          2        0.02    0.0000000
## 2:       0.05          7        0.07    0.0000000
## 3:       0.10         16        0.13    0.1875000
## 4:       0.20         27        0.19    0.2962963
```

``` r
cat("\n\nGuidelines:\n")
```

```
## 
## 
## Guidelines:
```

``` r
cat("• FDR = 0.01: Conservative, high confidence in findings\n")
```

```
## <U+2022> FDR = 0.01: Conservative, high confidence in findings
```

``` r
cat("• FDR = 0.05: Standard choice, balanced\n")
```

```
## <U+2022> FDR = 0.05: Standard choice, balanced
```

``` r
cat("• FDR = 0.10: Lenient, for exploratory screening\n")
```

```
## <U+2022> FDR = 0.10: Lenient, for exploratory screening
```

``` r
cat("• FDR = 0.20: Very lenient, for initial discovery\n")
```

```
## <U+2022> FDR = 0.20: Very lenient, for initial discovery
```

---

## 15.15 Visualising Multiple Testing Results

### 15.15.1 Volcano Plots


``` r
# Create volcano plot data
set.seed(456)
volcano_data <- data.table(
    gene = paste0("Gene_", 1:n_tests),
    log2FC = c(rnorm(n_true, 1.5, 0.5), rnorm(n_tests - n_true, 0, 0.3)),
    true_effect = true_effect
)
volcano_data[, p_value := results$p_value]
volcano_data[, neg_log10_p := -log10(p_value)]
volcano_data[, significant := p.adjust(p_value, method = "BH") < 0.05]

ggplot2$ggplot(volcano_data, ggplot2$aes(x = log2FC, y = neg_log10_p, colour = significant)) +
    ggplot2$geom_point(alpha = 0.5) +
    ggplot2$geom_hline(yintercept = -log10(0.05), linetype = "dashed", colour = "grey50") +
    ggplot2$scale_colour_manual(values = c("#0072B2", "#D55E00"),
                                 labels = c("Not Significant", "Significant (FDR < 5%)")) +
    ggplot2$labs(
        title = "Volcano Plot: Effect Size vs Significance",
        subtitle = "Points coloured by FDR-corrected significance",
        x = "Log₂ Fold Change",
        y = "-Log₁₀(P-Value)",
        colour = ""
    ) +
    ggplot2$theme_minimal(base_size = 12) +
    ggplot2$theme(legend.position = "bottom")
```

![plot of chunk volcano_plot](/courses/statistics-1-foundations/volcano_plot-1.png)

---

## Quick Reference

### FDR Methods

| Method | Controls | Assumption |
|--------|----------|------------|
| Benjamini-Hochberg | FDR | Independence or PRDS |
| Benjamini-Yekutieli | FDR | Any dependence |
| Storey Q-Value | FDR | Estimates π₀ |
| Local FDR | Individual probability | Mixture model |

### R Functions

| Function | Purpose |
|----------|---------|
| `p.adjust(p, method = "BH")` | Benjamini-Hochberg |
| `p.adjust(p, method = "BY")` | Benjamini-Yekutieli |
| `qvalue::qvalue(p)` | Storey's q-values |
| `fdrtool::fdrtool()` | Local FDR |

### Choosing FDR Level

| FDR Level | Use Case |
|-----------|----------|
| 0.01 | High-confidence findings |
| 0.05 | Standard (most common) |
| 0.10 | Exploratory screening |
| 0.20 | Very preliminary discovery |

