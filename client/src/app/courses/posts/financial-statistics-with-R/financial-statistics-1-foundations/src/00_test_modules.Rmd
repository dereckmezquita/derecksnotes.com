---
title: "Module Test - Proof of Concept"
author: "Algorithmic Trading with R"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE,
    fig.width = 10,
    fig.height = 6
)

# Set working directory to course root (where src/ folder is)
# The Rmd file is in financial-statistics-1-foundations/, and src/ is also there
course_root <- dirname(knitr::current_input(dir = TRUE))
knitr::opts_knit$set(root.dir = course_root)
setwd(course_root)
```

# Module Import Test

This document tests that our `box::use()` module system works correctly.

## Load Modules

```{r load-modules}
# Using box::use() for modular imports
box::use(
    ./modules/data[
        load_market, load_factors, load_vix, load_economic,
        load_returns, list_market_symbols, filter_dates
    ],
    ./modules/stats[
        sharpe_ratio, max_drawdown, return_summary, format_summary,
        annualised_return, annualised_vol, rolling_vol
    ],
    ./modules/viz[
        plot_cumulative_returns, plot_drawdown, plot_return_dist,
        plot_rolling_vol, plot_multi_returns, theme_trading, trading_colors
    ]
)

# Also load data.table and ggplot2 directly for any ad-hoc work
library(data.table)
library(ggplot2)
```

## Test Data Loading

### Market Data

```{r test-market-data}
# Load S&P 500 data
sp500 <- load_market("sp500")
cat("S&P 500 data loaded:\n")
cat("  Rows:", nrow(sp500), "\n")
cat("  Date range:", as.character(min(sp500$date)), "to", as.character(max(sp500$date)), "\n")
cat("  Columns:", paste(names(sp500), collapse = ", "), "\n")

# Preview
head(sp500)
```

```{r list-symbols}
# List available market symbols
symbols <- list_market_symbols()
cat("Available market symbols:", length(symbols), "\n")
cat("First 20:", paste(head(symbols, 20), collapse = ", "), "\n")
```

### Factor Data

```{r test-factor-data}
# Load Fama-French 3-factor data
ff3 <- load_factors("ff3", "daily")
cat("FF3 factors loaded:\n")
cat("  Rows:", nrow(ff3), "\n")
cat("  Date range:", as.character(min(ff3$date)), "to", as.character(max(ff3$date)), "\n")
cat("  Columns:", paste(names(ff3), collapse = ", "), "\n")

head(ff3)
```

### VIX Term Structure

```{r test-vix-data}
# Load VIX term structure
vix_ts <- load_vix("term_structure")
cat("VIX term structure loaded:\n")
cat("  Rows:", nrow(vix_ts), "\n")
cat("  Columns:", paste(names(vix_ts), collapse = ", "), "\n")

head(vix_ts)
```

### Economic Data

```{r test-economic-data}
# Load Treasury yields
yields <- load_economic("interest_rate_term_structure")
cat("Treasury yields loaded:\n")
cat("  Rows:", nrow(yields), "\n")
cat("  Columns:", paste(names(yields), collapse = ", "), "\n")

head(yields)
```

## Test Statistics Functions

```{r test-stats}
# Calculate return statistics for S&P 500
sp500_returns <- sp500$returns[!is.na(sp500$returns)]

# Individual stats
cat("S&P 500 Return Statistics (Daily data, 2000-present):\n")
cat("  Annualised Return:", round(annualised_return(sp500_returns) * 100, 2), "%\n")
cat("  Annualised Vol:", round(annualised_vol(sp500_returns) * 100, 2), "%\n")
cat("  Sharpe Ratio:", round(sharpe_ratio(sp500_returns), 2), "\n")
cat("  Max Drawdown:", round(max_drawdown(sp500_returns) * 100, 2), "%\n")
```

```{r full-summary}
# Full summary
summary_stats <- return_summary(sp500_returns)
summary_dt <- format_summary(summary_stats, "SP500")
print(summary_dt)
```

## Test Visualisation Functions

### Cumulative Returns

```{r plot-cumulative}
# Filter to recent years for clearer visualisation
sp500_recent <- filter_dates(sp500, "2020-01-01")

plot_cumulative_returns(
    sp500_recent,
    title = "S&P 500 Cumulative Returns (2020-Present)"
)
```

### Drawdown

```{r plot-drawdown}
plot_drawdown(
    sp500_recent,
    title = "S&P 500 Drawdown (2020-Present)"
)
```

### Return Distribution

```{r plot-distribution}
plot_return_dist(
    sp500,
    title = "S&P 500 Daily Return Distribution"
)
```

### Rolling Volatility

```{r plot-rolling-vol}
plot_rolling_vol(
    sp500_recent,
    window = 20,
    title = "S&P 500 20-Day Rolling Volatility"
)
```

## Multi-Asset Comparison

```{r multi-asset}
# Load multiple asset returns
multi_returns <- load_returns(c("spy", "qqq", "gld", "tlt"))
multi_returns <- filter_dates(multi_returns, "2020-01-01")

cat("Multi-asset returns loaded:\n")
cat("  Rows:", nrow(multi_returns), "\n")
cat("  Assets:", paste(setdiff(names(multi_returns), "date"), collapse = ", "), "\n")

plot_multi_returns(
    multi_returns,
    title = "Multi-Asset Cumulative Returns (2020-Present)"
)
```

## Factor Analysis Example

```{r factor-analysis}
# Merge AAPL with factors
aapl <- load_market("aapl")
aapl_recent <- filter_dates(aapl, "2020-01-01")[, .(date, returns)]
setnames(aapl_recent, "returns", "AAPL")

ff3_recent <- filter_dates(ff3, "2020-01-01")

# Merge
aapl_factors <- merge(aapl_recent, ff3_recent, by = "date")
aapl_factors <- aapl_factors[complete.cases(aapl_factors)]

# Run regression
model <- lm(AAPL ~ Mkt_RF + SMB + HML, data = aapl_factors)
summary(model)
```

```{r factor-plot}
# Plot AAPL vs Market
ggplot(aapl_factors, aes(x = Mkt_RF, y = AAPL)) +
    geom_point(alpha = 0.3, color = trading_colors$primary) +
    geom_smooth(method = "lm", color = trading_colors$negative, se = TRUE) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    geom_vline(xintercept = 0, linetype = "dashed") +
    labs(
        title = "AAPL vs Market Factor",
        subtitle = sprintf("Beta = %.2f", coef(model)["Mkt_RF"]),
        x = "Market Excess Return (Mkt-RF)",
        y = "AAPL Return"
    ) +
    theme_trading()
```

## VIX Term Structure Analysis

```{r vix-term-structure}
# Plot VIX term structure over time
vix_long <- melt(vix_ts, id.vars = "date", variable.name = "tenor", value.name = "vix_level")
vix_long <- vix_long[date >= "2020-01-01"]

ggplot(vix_long, aes(x = date, y = vix_level, color = tenor)) +
    geom_line(linewidth = 0.5) +
    labs(
        title = "VIX Term Structure Over Time",
        subtitle = "Backwardation indicates market stress",
        x = NULL,
        y = "VIX Level"
    ) +
    theme_trading()
```

---

# Summary

All modules loaded and working correctly:

- **data.R**: Successfully loads market, factor, VIX, and economic data
- **stats.R**: Successfully calculates return statistics, Sharpe ratios, drawdowns
- **viz.R**: Successfully creates visualisations with consistent theming

The `box::use()` import system is working as expected. Ready to build course content!
